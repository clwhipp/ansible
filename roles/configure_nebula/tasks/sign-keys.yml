- name: Delete nebula working directory on ansible host
  file:
    path: "./.nebula"
    state: absent
  delegate_to: localhost
  become: false

- name: Create nebula working directory on ansible host
  ansible.builtin.file:
    path: ".nebula"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false

- name: Download host public key to ansible host
  ansible.builtin.fetch:
    src: "/home/{{ user }}/Documents/exports/{{ inventory_hostname }}-host.pub"
    dest: "./.nebula/{{ inventory_hostname }}-host.pub"
    flat: yes

- name: Generate devices certificate from profile
  nebula_sign:
    profile: "{{ nebula_sign_profile }}"
    config: "{{ playbook_dir }}/certificates/nebula/issuance-profiles.yaml"
    ca_key: ".nebula/ca.key"
    ca_key_pass: "{{ nebula_ca_key_password }}"
    ca_crt:  "{{ playbook_dir }}/certificates/nebula/{{ cert_env }}/ca.crt"
    public:  "./.nebula/{{ inventory_hostname }}-host.pub"
    out_crt: "{{ playbook_dir }}/certificates/nebula/{{ cert_env }}/{{ inventory_hostname }}-host.crt"
  delegate_to: localhost
  become: false
  no_log: true

# - name: Upload issuance-profile to capture log
#   bitwarden_update_attachment:
#     name: "NEBULA_CA"
#     file_path: ".nebula/issuance-profiles.yaml"
#   delegate_to: localhost
#   become: false

- name: Check if {{ nebula_install_dir }}/host.crt
  ansible.builtin.stat:
    path: "{{ nebula_install_dir }}/host.crt"
  register: host_cert_stat

- name: Backing up {{ nebula_install_dir }}/host.crt
  ansible.builtin.copy:
    src: "{{ nebula_install_dir }}/host.crt"
    dest: "{{ nebula_install_dir }}/host-backup.crt"
    remote_src: true
  when: host_cert_stat.stat.exists

- name: Upload host certificate to host
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/certificates/nebula/{{ cert_env }}/{{ inventory_hostname }}-host.crt"
    dest: "{{ nebula_install_dir }}/host.crt"
    owner: "root"
    group: "{{ nebula_user }}"
    mode: '0750'

- name: Delete nebula directory
  file:
    path: "./.nebula"
    state: absent
  delegate_to: localhost
  become: false
